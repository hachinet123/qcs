<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tre.centralkitchen.mapper.TrOutTransbillMapper">

    <select id="decideProductionResultsTemp"
            resultType="com.tre.centralkitchen.domain.vo.system.DecideProductionResultsVo">

        Select 0 As slipNo
        , 0 As lineNo
        , H.dlvsched_date
        , H.mail_no
        , H.store_id
        , H.item_id
        , COALESCE(H.place_id, 0) as place_id
        , H.lot_no
        , H.machine_no
        , H.cost_rcp
        , H.cost_item
        , H.price
        , H.inst_qy
        , COALESCE(H.act_qy, 0) as act_qy
        , COALESCE(H.weight, 0) as weight
        , M.department_id
        From centralkitchen.tr_produced H
        Inner Join centralkitchen.purchasegroupbranches TMB
        On H.store_id = TMB.branchcd
        Left Join centralkitchen.tm_shohin M
        On H.item_id = M.item_id
        And M.store_id = 0
        And M.area_id = TMB.purchasegroupcd
        Where H.dlvsched_date = (Select dlvsched_date
        From centralkitchen.mt_mailcontrol
        Where center_id = #{centerId}
        And mail_no = #{mailNo}
        <if test='pctgtTypeId == 1'>
            And produced_import_date is not null
            And produced_confirmed_date is null
        </if>
        <if test='pctgtTypeId == 2'>
            And through_confirmed_date is null
            And H.act_qy is not null
            And H.act_qy <![CDATA[ <>]]> 0
        </if>
        )
        And H.center_id = #{centerId}
        And H.mail_no = #{mailNo}
        And COALESCE(M.pctgt_typeid, 0) = #{pctgtTypeId}
        And H.act_qy is not null
        Order By H.dlvsched_date
        , H.mail_no
        , H.store_id
        , M.department_id
        , H.item_id

    </select>

    <update id="decideProductionResultsOnFixAmount">
        CREATE
        TEMPORARY TABLE tmpProduced (
        slipNo int4,
        lineNo int4,
        dlvschedDate date,
        mailNo int2,
        storeId int4,
        itemId varchar(13),
        placeId int4,
        lotNo varchar(12),
        machineNo int2,
        costRcp numeric(8,2),
        costItem numeric(8,2),
        price int4,
        instQy int4,
        actQy int4,
        weight numeric(10,2),
        departmentId int4
        );
        Insert Into tmpProduced
        Select slip_code,
               line_no,
               dlvsched_date,
               mail_no,
               store_id,
               item_id,
               place_id,
               lot_no,
               machine_no,
               cost_rcp,
               cost_item,
               price,
               inst_qy,
               act_qy,
               weight,
               department_id
        From centralkitchen.wk_decide_production_results
        Where id = #{uuid};

        Insert Into centralkitchen.tr_out_transitem
        ( slip_code
        , dlvsched_date
        , mail_no
        , center_id
        , store_id
        , line_no
        , item_id
        , place_id
        , lot_no
        , qy
        , weight_am
        , cost_rcp
        , cost
        , price
        , recipe_am
        , order_am
        , sales_am
        , wm_typeid
        , f_del
        , ins_user_id
        , ins_func_id
        , ins_ope_id
        , ins_date
        , ins_time
        , upd_user_id
        , upd_func_id
        , upd_ope_id
        , upd_date
        , upd_time)
        Select H.slipNo
             , H.dlvschedDate
             , H.mailNo
             , #{centerId}
             , H.storeId
             , H.lineNo
             , H.itemId
             , H.placeId
             , H.lotNo
             , H.actQy
             , H.weight
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp) / H.actQy), 2)
                             ELSE ROUND(H.costRcp, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem) / H.actQy), 2)
                             ELSE ROUND(H.costItem, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price) / H.actQy), 0)
                             ELSE ROUND(H.price, 0) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.price), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.price), 0)
                       END) END
             , 1
             , 0
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
        From tmpProduced H
                 Left Join centralkitchen.purchasegroupbranches TMS
                           On H.storeId = TMS.branchcd
                 Left Join centralkitchen.tm_shohin M
                           On H.itemId = M.item_id
                               And M.store_id = 0
                               And M.area_id = TMS.purchasegroupcd
        Where M.pctgt_typeid = 2
          And COALESCE(M.teikan_typeid, 0) = 1
        Group by H.slipNo
               , H.dlvschedDate
               , H.mailNo
               , H.storeId
               , H.lineNo
               , H.itemId
               , H.placeId
               , H.lotNo
               , H.actQy
               , H.weight
               , H.costRcp
               , H.costItem
               , H.price
               , m.teikan_typeid;

        Insert Into centralkitchen.tr_out_transitem
        ( slip_code
        , dlvsched_date
        , mail_no
        , center_id
        , store_id
        , line_no
        , item_id
        , place_id
        , lot_no
        , qy
        , weight_am
        , cost_rcp
        , cost
        , price
        , recipe_am
        , order_am
        , sales_am
        , wm_typeid
        , f_del
        , ins_user_id
        , ins_func_id
        , ins_ope_id
        , ins_date
        , ins_time
        , upd_user_id
        , upd_func_id
        , upd_ope_id
        , upd_date
        , upd_time)
        Select H.slipNo
             , H.dlvschedDate
             , H.mailNo
             , #{centerId}
             , H.storeId
             , H.lineNo
             , H.itemId
             , H.placeId
             , H.lotNo
             , H.actQy
             , H.weight
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp) / H.actQy), 2)
                             ELSE ROUND(H.costRcp, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem) / H.actQy), 2)
                             ELSE ROUND(H.costItem, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price) / H.actQy), 0)
                             ELSE ROUND(H.price, 0) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.price), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.price), 0)
                       END) END
             , M.teikan_typeid
             , 0
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
        From tmpProduced H
                 Left Join centralkitchen.purchasegroupbranches TMS
                           On H.storeId = TMS.branchcd
                 Left Join centralkitchen.tm_shohin M
                           On H.itemId = M.item_id
                               And M.store_id = 0
                               And M.area_id = TMS.purchasegroupcd
        Where COALESCE(M.pctgt_typeid, 0) = 2
          And COALESCE(M.teikan_typeid, 0) = 0
        Group by H.slipNo
               , H.dlvschedDate
               , H.mailNo
               , H.storeId
               , H.lineNo
               , H.itemId
               , H.placeId
               , H.lotNo
               , H.actQy
               , H.weight
               , H.costRcp
               , H.costItem
               , H.price
               , m.teikan_typeid;

        Insert Into centralkitchen.tr_out_transbill
        ( slip_code
        , dlvsched_date
        , mail_no
        , center_id
        , store_id
        , out_date
        , qy_am
        , weight_am
        , r_am
        , o_am
        , s_am
        , wm_typeid
        , department_id
        , f_del
        , ins_user_id
        , ins_func_id
        , ins_ope_id
        , ins_date
        , ins_time
        , upd_user_id
        , upd_func_id
        , upd_ope_id
        , upd_date
        , upd_time)
        Select H.slipNo
             , H.dlvschedDate
             , H.mailNo
             , #{centerId}
             , H.storeId
             , now()
             , Sum(H.actQy)
             , Sum(H.weight)
             , Sum(TD.recipe_am)
             , Sum(TD.order_am)
             , Sum(TD.sales_am)
             , 1
             , M.department_id
             , 0
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
        From tmpProduced H
                 Inner Join centralkitchen.tr_out_transitem TD
                            On H.slipNo = TD.slip_code
                                And H.dlvschedDate = TD.dlvsched_date
                                And #{centerId} = TD.center_id
                                And H.mailNo = TD.mail_no
                                And H.storeId = TD.store_id
                                And H.lineNo = TD.line_no
                 Left Join centralkitchen.purchasegroupbranches TMS
                           On H.storeId = TMS.branchcd
                 Left Join centralkitchen.tm_shohin M
                           On H.itemId = M.item_id
                               And M.area_id = TMS.purchasegroupcd
                               And M.store_id = 0
        Where M.pctgt_typeid = 2
        Group By H.dlvschedDate,
                 H.mailNo,
                 H.storeId,
                 H.slipNo,
                 M.department_id;

        Update centralkitchen.mt_mailcontrol
        Set through_confirmed_date = now()
          , out_confirmed_date = now()
          , upd_date = now()
          , upd_time = now()
          , upd_user_id = #{userId}::int4
          , upd_func_id = #{funcId}
          , upd_ope_id  = #{opeId}
        Where center_id = #{centerId}
          And mail_no = #{mailNo};

        Drop table tmpProduced;
    </update>

    <update id="decideProductionResults">
        CREATE
        TEMPORARY TABLE tmpProduced (
        slipNo int4,
        lineNo int4,
        dlvschedDate date,
        mailNo int2,
        storeId int4,
        itemId varchar(13),
        placeId int4,
        lotNo varchar(12),
        machineNo int2,
        costRcp numeric(8,2),
        costItem numeric(8,2),
        price int4,
        instQy int4,
        actQy int4,
        weight numeric(10,2),
        departmentId int4
        );
        Insert Into tmpProduced
        Select slip_code,
               line_no,
               dlvsched_date,
               mail_no,
               store_id,
               item_id,
               place_id,
               lot_no,
               machine_no,
               cost_rcp,
               cost_item,
               price,
               inst_qy,
               act_qy,
               weight,
               department_id
        From centralkitchen.wk_decide_production_results
        Where id = #{uuid};


        Insert Into centralkitchen.tr_out_transitem
        ( slip_code
        , dlvsched_date
        , mail_no
        , center_id
        , store_id
        , line_no
        , item_id
        , place_id
        , lot_no
        , qy
        , weight_am
        , cost_rcp
        , cost
        , price
        , recipe_am
        , order_am
        , sales_am
        , wm_typeid
        , f_del
        , ins_user_id
        , ins_func_id
        , ins_ope_id
        , ins_date
        , ins_time
        , upd_user_id
        , upd_func_id
        , upd_ope_id
        , upd_date
        , upd_time)
        Select H.slipNo
             , H.dlvschedDate
             , H.mailNo
             , #{centerId}
             , H.storeId
             , H.lineNo
             , H.itemId
             , H.placeId
             , H.lotNo
             , H.actQy
             , H.weight
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp) / H.actQy), 2)
                             ELSE ROUND(H.costRcp, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem) / H.actQy), 2)
                             ELSE ROUND(H.costItem, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price) / H.actQy), 0)
                             ELSE ROUND(H.price, 0) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.price), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.price), 0)
                       END) END
             , M.teikan_typeid
             , 0
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
        From tmpProduced H
                 Inner Join centralkitchen.purchasegroupbranches TMS
                            On H.storeId = TMS.branchcd
                 Left Join centralkitchen.tm_shohin M
                           On H.itemId = M.item_id
                               And M.store_id = 0
                               And M.area_id = TMS.purchasegroupcd
        Where COALESCE(M.pctgt_typeid, 0) = 1
          And M.teikan_typeid = 1
        Group by H.slipNo
               , H.dlvschedDate
               , H.mailNo
               , H.storeId
               , H.lineNo
               , H.itemId
               , H.placeId
               , H.lotNo
               , H.actQy
               , H.weight
               , H.costRcp
               , H.costItem
               , H.price
               , m.teikan_typeid;

        Insert Into centralkitchen.tr_out_transitem
        ( slip_code
        , dlvsched_date
        , mail_no
        , center_id
        , store_id
        , line_no
        , item_id
        , place_id
        , lot_no
        , qy
        , weight_am
        , cost_rcp
        , cost
        , price
        , recipe_am
        , order_am
        , sales_am
        , wm_typeid
        , f_del
        , ins_user_id
        , ins_func_id
        , ins_ope_id
        , ins_date
        , ins_time
        , upd_user_id
        , upd_func_id
        , upd_ope_id
        , upd_date
        , upd_time)
        Select H.slipNo
             , H.dlvschedDate
             , H.mailNo
             , #{centerId}
             , H.storeId
             , H.lineNo
             , H.itemId
             , H.placeId
             , H.lotNo
             , H.actQy
             , H.weight
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp) / H.actQy), 2)
                             ELSE ROUND(H.costRcp, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem) / H.actQy), 2)
                             ELSE ROUND(H.costItem, 2) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price) / H.actQy), 0)
                             ELSE ROUND(H.price, 0) END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costRcp)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costRcp), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.costItem)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.costItem), 0)
                       END) END
             , CASE SUM(H.actQy)
                   WHEN 0 THEN 0
                   ELSE (CASE M.teikan_typeid
                             WHEN 0 THEN ROUND((SUM(H.weight / 100) * (H.price)), 0)
                             WHEN 1 THEN ROUND((SUM(H.actQy) * H.price), 0)
                             WHEN 2 THEN ROUND((SUM(H.actQy) * H.price), 0)
                       END) END
             , M.teikan_typeid
             , 0
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
        From tmpProduced H
                 Inner Join centralkitchen.purchasegroupbranches TMS
                            On H.storeId = TMS.branchcd
                 Left Join centralkitchen.tm_shohin M
                           On H.itemId = M.item_id
                               And M.store_id = 0
                               And M.area_id = TMS.purchasegroupcd
        Where COALESCE(M.pctgt_typeid, 0) = 1
          And M.teikan_typeid = 0
        Group by H.slipNo
               , H.dlvschedDate
               , H.mailNo
               , H.storeId
               , H.lineNo
               , H.itemId
               , H.placeId
               , H.lotNo
               , H.actQy
               , H.weight
               , H.costRcp
               , H.costItem
               , H.price
               , m.teikan_typeid;

        Insert Into centralkitchen.tr_out_transbill
        ( slip_code
        , dlvsched_date
        , mail_no
        , center_id
        , store_id
        , out_date
        , qy_am
        , weight_am
        , r_am
        , o_am
        , s_am
        , wm_typeid
        , department_id
        , f_del
        , ins_user_id
        , ins_func_id
        , ins_ope_id
        , ins_date
        , ins_time
        , upd_user_id
        , upd_func_id
        , upd_ope_id
        , upd_date
        , upd_time)
        Select H.slipNo
             , H.dlvschedDate
             , H.mailNo
             , #{centerId}
             , H.storeId
             , now()
             , Sum(H.actQy)
             , Sum(H.weight)
             , Sum(TD.recipe_am)
             , Sum(TD.order_am)
             , Sum(TD.sales_am)
             , 0
             , M.department_id
             , 0
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
             , #{userId}::int4
        ,#{funcId}
             , #{opeId}
             , now()
             , now()
        From tmpProduced H
                 Inner Join centralkitchen.tr_out_transitem TD
                            On H.slipNo = TD.slip_code
                                And H.dlvschedDate = TD.dlvsched_date
                                And #{centerId} = TD.center_id
                                And H.mailNo = TD.mail_no
                                And H.storeId = TD.store_id
                                And H.lineNo = TD.line_no
                 Inner Join centralkitchen.purchasegroupbranches TMS
                            On H.storeId = TMS.branchcd
                 Left Join centralkitchen.tm_shohin M
                           On H.itemId = M.item_id
                               And M.area_id = TMS.purchasegroupcd
                               And M.store_id = 0
        Where COALESCE(M.pctgt_typeid, 0) = 1
        Group By H.dlvschedDate,
                 H.mailNo,
                 H.storeId,
                 H.slipNo,
                 M.department_id;

        Update centralkitchen.mt_mailcontrol
        Set produced_confirmed_date = now()
          , out_confirmed_date = now()
          , upd_date = now()
          , upd_time = now()
          , upd_user_id = #{userId}::int4
          , upd_func_id = #{funcId}
          , upd_ope_id  = #{opeId}
        Where center_id = #{centerId}
          And mail_no = #{mailNo};

        Drop Table tmpProduced;
    </update>

    <update id="decideProductionResultsPacks">
        /*Step12_PC SeverのT_D出庫伝票→PC SeverのT_W仕入伝票累積
        PC SeverのT_D出庫明細→PC SeverのT_W仕入明細累積*/

        -- SendDecDatatoWPC

        --Step1_PC SeverのT_D出庫伝票とT_D出庫明細→PC SeverのT_W振替伝票送信

        --TRUNCATE TABLE T_W振替伝票送信
        DELETE FROM centralkitchen.wk_odr_transbill
        Where center_id=#{centerId} and f_send = 1;

        Insert Into centralkitchen.wk_odr_transbill
        (center_id,
        trans_date,
        transbill_id,
        id_1st,
        bill_kindid,
        transbill_code,
        out_org_id,
        out_department_id,
        in_org_id,
        in_department_id,
        itemid_typeid,
        o_transbill_id,
        dlvbill_id,
        vendor_id,
        bill_date,
        mail_no,
        in_date,
        count_date,
        dlvroute_typeid,
        tcdc_typeid,
        dlvway_typeid,
        shipping_typeid,
        thermal_zone_typeid,
        o_am,
        s_am,
        f_del,
        ins_date,
        ins_time,
        upd_date,
        upd_time,
        ins_user_id,
        ins_func_id,
        ins_ope_id,
        upd_user_id,
        upd_func_id,
        upd_ope_id,
        line_no,
        qy,
        cost,
        order_am,
        sales_am,
        price,
        item_id,
        accitem_id,
        in_item_id,
        reason_typeid,
        f_send,
        send_date
        )
        Select
        a.center_id
        ,a.dlvsched_date
        ,NULL
        ,NULL
        ,30
        ,a.slip_code
        ,case a.mail_no when 20 then a.store_id else a.center_id end
        ,a.department_id
        ,case a.mail_no when 20 then a.center_id else a.store_id end
        ,a.department_id
        ,NULL
        ,NULL
        ,NULL
        ,(Select vendor_id From centralkitchen.mt_centerstatus Where center_id = #{centerId})
        ,a.dlvsched_date
        ,a.mail_no
        ,a.dlvsched_date
        ,a.dlvsched_date
        ,1
        ,3
        ,1
        ,0
        ,2
        ,ABS(a.o_am)
        ,ABS(a.s_am)
        ,0
        ,now()
        ,now()
        ,now()
        ,now()
        ,#{userId}::int4
        ,#{funcId}
        ,#{opeId}
        ,#{userId}::int4
        ,#{funcId}
        ,#{opeId}
        ,COALESCE(b.line_no,0)
        ,ABS((b.qy*1000))
        ,(b.cost*1000)
        ,ABS(b.order_am)
        ,ABS(b.sales_am)
        ,b.price
        ,b.item_id
        ,NULL
        ,NULL
        ,99
        ,0
        ,now()
        From centralkitchen.tr_out_transbill As a
        Left Join centralkitchen.mt_mailcontrol As bin
        On a.center_id = bin.center_id And a.mail_no=bin.mail_no
        Left Join centralkitchen.tr_out_transitem As b
        On a.slip_code=b.slip_code
        And a.dlvsched_date=b.dlvsched_date
        And a.center_id=b.center_id
        And a.mail_no = b.mail_no
        And a.store_id=b.store_id
        Inner Join centralkitchen.wk_decide_production_results tmp
        On tmp.id = #{uuid}
        And b.center_id=#{centerId}
        And b.mail_no=tmp.mail_no
        And b.slip_code=tmp.slip_code
        And b.dlvsched_date=tmp.dlvsched_date
        And b.store_id=tmp.store_id
        And b.line_no=tmp.line_no
        Left Join centralkitchen.purchasegroupbranches TMS
        On b.store_id=TMS.branchcd
        Left Join centralkitchen.tm_shohin M
        On b.item_id = M.item_id
        And M.store_id = 0
        And M.area_id=TMS.purchasegroupcd
        Where a.dlvsched_date=bin.dlvsched_date
        And a.center_id = #{centerId}
        And a.mail_no = #{mailNo}
        And a.store_id <![CDATA[ <]]> 999
        And M.pctgt_typeid = #{pctgtTypeId};

        Delete
        From centralkitchen.wk_decide_production_results
        Where id = #{uuid};
    </update>

    <select id="getReturnNO" resultType="java.lang.Integer">
        Select count(1) as number
        From centralkitchen.mt_mailcontrol mt
                 inner join centralkitchen.tr_out_transbill tr
                            on mt.dlvsched_date = tr.dlvsched_date
                                And mt.center_id = tr.center_id
                                And mt.mail_no = tr.mail_no
                 inner join centralkitchen.wk_odr_transbill wtr
                            on mt.dlvsched_date = wtr.trans_date
                                And mt.center_id = wtr.center_id
                                And mt.mail_no = wtr.mail_no
        Where mt.center_id = #{centerId}
          And mt.mail_no = #{mailNo}
          And tr.wm_typeid = 0
          And wtr.f_send <![CDATA[ <>]]> 0

    </select>

    <update id="productionResultsReturn">

        --T_W振替伝票送信のデータをゼロ訂正
        UPDATE
            centralkitchen.wk_odr_transbill wk
        SET o_am        = 0,
            s_am        = 0,
            qy          = 0,
            order_am    = 0,
            sales_am    = 0,
            f_send      = 0,
            upd_date    = now(),
            upd_time    = now(),
            upd_func_id = #{funcId},
            upd_ope_id  = #{opeId} FROM centralkitchen.tr_out_transbill tr
        Where tr.slip_code = wk.transbill_code
          And tr.dlvsched_date = wk.trans_date
          And tr.dlvsched_date = (Select
            Case When leadtime = 0
          And through_confirmed_date is not null
          And produced_confirmed_date is not null
            then dlvsched_date Else dlvsched_date end
            From
            centralkitchen.mt_mailcontrol
            Where center_id = #{centerId}
          And mail_no = #{mailNo})
          And tr.center_id = #{centerId}
          And tr.mail_no = #{mailNo}
          And tr.wm_typeid = 0;

        --T_D出庫明細のデータ更新
        UPDATE
            centralkitchen.tr_out_transitem tri
        SET qy          = 0,
            weight_am   = 0,
            recipe_am   = 0,
            order_am    = 0,
            sales_am    = 0,
            mail_no     = 98,
            upd_date    = now(),
            upd_time    = now(),
            upd_user_id = #{userId}::int4,
            upd_func_id = #{funcId}, upd_ope_id = #{opeId}
        FROM centralkitchen.tr_out_transbill trb
        Where
            trb.slip_code = tri.slip_code
          And trb.dlvsched_date = tri.dlvsched_date
          And trb.dlvsched_date = (Select
            Case When leadtime = 0
          And through_confirmed_date is not null
          And produced_confirmed_date is not null
            then dlvsched_date Else dlvsched_date end
            From centralkitchen.mt_mailcontrol
            Where center_id = #{centerId}
          And mail_no = #{mailNo})
          And trb.center_id = #{centerId}
          And trb.mail_no = #{mailNo}
          And trb.wm_typeid = 0;


        --T_D出庫伝票のデータの更新
        UPDATE
            centralkitchen.tr_out_transbill trb
        SET mail_no     = 98,
            qy_am       = 0,
            weight_am   = 0,
            r_am        = 0,
            o_am        = 0,
            s_am        = 0,
            upd_date    = now(),
            upd_time    = now(),
            upd_user_id = #{userId}::int4,
            upd_func_id = #{funcId}, upd_ope_id = #{opeId}
        Where dlvsched_date = (Select Case
            When leadtime = 0
          And through_confirmed_date is not null
          And produced_confirmed_date is not null
            then dlvsched_date
            Else dlvsched_date
            end
            From centralkitchen.mt_mailcontrol
            Where center_id = #{centerId}
          And mail_no = #{mailNo} )
          And center_id = #{centerId}
          And mail_no = #{mailNo}
          And wm_typeid = 0;
    </update>

    <update id="productionResultsReturnBack">
        --T_D出庫明細のデータの更新
        UPDATE centralkitchen.tr_out_transitem D
        SET mail_no     = 98
          , qy          = 0
          , weight_am   = 0
          , cost_rcp    = 0
          , cost        = 0
          , price       = 0
          , recipe_am   = 0
          , order_am    = 0
          , sales_am    = 0
          , upd_date    = now()
          , upd_time    = now()
          , upd_user_id = #{userId}::int4
          , upd_func_id = #{funcId}
          , upd_ope_id = #{opeId}
        FROM
            centralkitchen.tr_out_transbill H
        Where
            H.slip_code = D.slip_code
          And H.dlvsched_date = D.dlvsched_date
          And H.dlvsched_date = (Select dlvsched_date From centralkitchen.mt_mailcontrol Where center_id=#{centerId} And mail_no = #{mailNo} )
          And H.center_id = #{centerId}
          And H.mail_no = #{mailNo}
          And H.wm_typeid = 0;
        --T_D出庫伝票のデータの更新
        UPDATE centralkitchen.tr_out_transbill
        SET mail_no     = 98
          , qy_am       = 0
          , weight_am   = 0
          , r_am        = 0
          , o_am        = 0
          , s_am        = 0
          , upd_date    = now()
          , upd_time    = now()
          , upd_user_id = #{userId}::int4
          , upd_func_id = #{funcId}
          , upd_ope_id = #{opeId}
        Where dlvsched_date = (Select dlvsched_date From centralkitchen.mt_mailcontrol Where center_id = #{centerId}
          And mail_no = #{mailNo})
          And center_id = #{centerId}
          And mail_no = #{mailNo}
          And wm_typeid = 0;
    </update>
</mapper>